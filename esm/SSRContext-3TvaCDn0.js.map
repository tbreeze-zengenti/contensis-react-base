{"version":3,"file":"SSRContext-3TvaCDn0.js","sources":["../src/util/LruCache.js","../src/util/CachedDeliveryApi.ts","../src/util/ContensisDeliveryApi.ts","../src/util/SSRContext.tsx"],"sourcesContent":["class CacheNode {\n  constructor(key, value) {\n    this.key = key;\n    this.value = value;\n    this.next = null;\n    this.prev = null;\n  }\n}\n\nexport class LruCache {\n  constructor(limit = 100) {\n    this.map = {};\n    this.head = null;\n    this.tail = null;\n    this.limit = limit || 100;\n    this.size = 0;\n  }\n\n  get(key) {\n    if (this.map[key]) {\n      let value = this.map[key].value;\n      let node = new CacheNode(key, value);\n      this.remove(key);\n      this.setHead(node);\n      return value;\n    }\n  }\n\n  set(key, value) {\n    let node = new CacheNode(key, value);\n    if (this.map[key]) {\n      this.remove(key);\n    } else {\n      if (this.size >= this.limit) {\n        delete this.map[this.tail.key];\n        this.size--;\n        this.tail = this.tail.prev;\n        this.tail.next = null;\n      }\n    }\n    this.setHead(node);\n  }\n\n  setHead(node) {\n    node.next = this.head;\n    node.prev = null;\n    if (this.head) {\n      this.head.prev = node;\n    }\n    this.head = node;\n    if (!this.tail) {\n      this.tail = node;\n    }\n    this.size++;\n    this.map[node.key] = node;\n  }\n\n  remove(key) {\n    let node = this.map[key];\n    if (!node) return; // This is sometimes null and crashes the container without this check\n\n    if (node.prev) {\n      node.prev.next = node.next;\n    } else {\n      this.head = node.next;\n    }\n    if (node.next) {\n      node.next.prev = node.prev;\n    } else {\n      this.tail = node.prev;\n    }\n    delete this.map[key];\n    this.size--;\n  }\n}\n","import { VersionStatus } from 'contensis-core-api';\nimport { Client, Query } from 'contensis-delivery-api';\nimport {\n  INodeOperations,\n  NodeGetRootOptions,\n} from 'contensis-delivery-api/lib/models';\n\nimport {\n  DeliveryApi,\n  SSRContext,\n  getClientConfig,\n} from './ContensisDeliveryApi';\nimport { LruCache } from './LruCache';\nimport { CookieObject } from '~/user/util/CookieConstants';\n\n// CachedSearch does not cache results in SSR by design\nclass CachedSearch {\n  cache = new LruCache();\n  cookies?: CookieObject;\n  ssr?: SSRContext;\n\n  constructor(ssr?: SSRContext) {\n    this.ssr = ssr;\n    this.cookies = this.ssr?.cookies.raw;\n  }\n\n  getClient(...args: Parameters<DeliveryApi['getClient']>) {\n    return new DeliveryApi(this.ssr).getClient(...args);\n  }\n\n  search(query: Query, linkDepth = 0, project?: string) {\n    const client = Client.create(getClientConfig(project, this.ssr));\n    return this.request(\n      `${project}+${JSON.stringify(query)}+${linkDepth}`,\n      () => client.entries.search(query, linkDepth)\n    );\n  }\n\n  searchUsingPost(query: Query, linkDepth = 0, project = '') {\n    const client = Client.create(getClientConfig(project, this.ssr));\n    return this.request(\n      `${project}+${JSON.stringify(query)}+${linkDepth}`,\n      () => (client.entries as any).searchUsingPost(query, linkDepth)\n    );\n  }\n\n  get(\n    id: string,\n    linkDepth = 0,\n    versionStatus: VersionStatus = 'published',\n    project?: string,\n    fields?: string[]\n  ) {\n    const client = Client.create({\n      ...getClientConfig(project, this.ssr),\n      versionStatus,\n    });\n    return this.request(id, () =>\n      client.entries.get({ id, linkDepth, fields })\n    );\n  }\n\n  getContentType(id: string, project?: string) {\n    const client = Client.create(getClientConfig(project, this.ssr));\n    return this.request(`[CONTENT TYPE] ${id} ${project}`, () =>\n      client.contentTypes.get(id)\n    );\n  }\n\n  getRootNode(\n    options: NodeGetRootOptions,\n    versionStatus: VersionStatus = 'published',\n    project?: string\n  ) {\n    const client = Client.create({\n      ...getClientConfig(project, this.ssr),\n      versionStatus,\n    });\n    return this.request(`${project} / ${JSON.stringify(options)}`, () =>\n      client.nodes.getRoot(options)\n    );\n  }\n\n  getNode(options: Parameters<INodeOperations['get']>[0], project?: string) {\n    const client = Client.create(getClientConfig(project, this.ssr));\n    return this.request(\n      `${project} ${\n        options && typeof options !== 'string'\n          ? 'path' in options\n            ? options.path\n            : options.id\n          : options\n      } ${JSON.stringify(options)}`,\n      () => client.nodes.get(options)\n    );\n  }\n\n  getAncestors(\n    options: Parameters<INodeOperations['getAncestors']>[0],\n    project?: string\n  ) {\n    const client = Client.create(getClientConfig(project, this.ssr));\n    return this.request(\n      `${project} [A] ${\n        (options && typeof options !== 'string' && options.id) || options\n      } ${JSON.stringify(options)}`,\n      () => client.nodes.getAncestors(options)\n    );\n  }\n\n  getChildren(\n    options: Parameters<INodeOperations['getChildren']>[0],\n    project?: string\n  ) {\n    const client = Client.create(getClientConfig(project, this.ssr));\n    return this.request(\n      `${project} [C] ${\n        (options && typeof options !== 'string' && options.id) || options\n      } ${JSON.stringify(options)}`,\n      () => client.nodes.getChildren(options)\n    );\n  }\n\n  getSiblings(\n    options: Parameters<INodeOperations['getSiblings']>[0],\n    project?: string\n  ) {\n    const client = Client.create(getClientConfig(project, this.ssr));\n    return this.request(\n      `${project} [S] ${\n        (options && typeof options !== 'string' && options.id) || options\n      } ${JSON.stringify(options)}`,\n      () => client.nodes.getSiblings(options)\n    );\n  }\n\n  request<T extends () => Promise<any>>(key: string, execute: T) {\n    // do not cache results in SSR\n    if (!this.cache.get(key) || typeof window == 'undefined') {\n      const promise = execute();\n      this.cache.set(key, promise);\n      promise.catch(() => {\n        this.cache.remove(key);\n      });\n    }\n    return this.cache.get(key) as ReturnType<T>;\n  }\n}\n\nexport const cachedSearch = new CachedSearch();\nexport const cachedSearchWithCookies = (ssr?: SSRContext) =>\n  new CachedSearch(ssr);\n","import { VersionStatus } from 'contensis-core-api';\nimport { Client, Query } from 'contensis-delivery-api';\nimport { Config } from 'contensis-delivery-api/lib/models';\nimport { parse } from 'query-string';\nimport { setSurrogateKeys } from '~/routing/redux/actions';\nimport { reduxStore } from '~/redux/store/store';\n\nimport { CookieObject, findLoginCookies } from '~/user/util/CookieConstants';\nimport { Request } from 'express';\nimport { IncomingHttpHeaders } from 'http';\nimport { SSRContext as SSRContextType } from '~/models';\n\nexport type SSRContext = Omit<SSRContextType, 'api'>;\n\nconst mapCookieHeader = (cookies: CookieObject | string) =>\n  typeof cookies === 'object'\n    ? Object.entries(cookies)\n        .map(([name, value]) => `${name}=${value}`)\n        .join('; ')\n    : cookies;\n\nconst getSsrReferer = ({ request }: SSRContext) => {\n  if (request) {\n    try {\n      const url = new URL(\n        request.url,\n        `${request.protocol || `http`}://${request.headers.host}`\n      );\n      return url.href;\n    } catch (ex) {\n      console.error(\n        `getSsrReferer cannot parse url ${request.url} and host ${request.headers.host}`\n      );\n\n      return request.url;\n    }\n  }\n\n  // if (typeof window === 'undefined') {\n  //   const state = reduxStore.getState();\n  //   const referer = `${selectCurrentHostname(state)}${selectCurrentPath(\n  //     state\n  //   )}${selectCurrentSearch(state)}`;\n\n  //   return referer;\n  // }\n  return '';\n};\n\n/**\n * Store the surrogate-key header contents in redux state to output in SSR response\n */\nconst storeSurrogateKeys = (ssr?: SSRContext) => (response: any) => {\n  let keys = '';\n  if (response.status === 200) {\n    keys = response.headers.get\n      ? response.headers.get('surrogate-key')\n      : response.headers.map['surrogate-key'];\n    if (!keys) console.info(`[storeSurrogateKeys] No keys in ${response.url}`);\n  }\n  // Using imported reduxStore in SSR is unreliable during high\n  // concurrent loads and exists here as a best effort fallback\n  // in case the SSRContext is not provided\n  const put = ssr?.dispatch || reduxStore?.dispatch;\n  put?.(setSurrogateKeys(keys, response.url, response.status));\n};\n\n/**\n * Create a new Config object to create a DeliveryAPI Client\n */\nconst deliveryApiConfig = (ssr?: SSRContext) => {\n  const config: Config = {\n    ...DELIVERY_API_CONFIG /* global DELIVERY_API_CONFIG */,\n  };\n\n  // Add SSR headers and handlers\n  if (typeof window === 'undefined') {\n    config.defaultHeaders = {\n      'x-require-surrogate-key': 'true', // request surrogate-key response header\n      'x-crb-ssr': 'true', // add this for support tracing\n    };\n    if (ssr) config.defaultHeaders.referer = getSsrReferer(ssr); // add this for support tracing\n\n    config.responseHandler = { [200]: storeSurrogateKeys(ssr) }; // for handling page cache invalidation\n  }\n\n  if (\n    typeof window !== 'undefined' &&\n    PROXY_DELIVERY_API /* global PROXY_DELIVERY_API */\n  ) {\n    // ensure a relative url is used to bypass the need for CORS (separate OPTIONS calls)\n    config.rootUrl = '';\n    config.responseHandler = { [404]: () => null };\n  }\n  return config;\n};\n\nexport const getClientConfig = (project?: string, ssr?: SSRContext) => {\n  const config = deliveryApiConfig(ssr);\n\n  if (project) {\n    config.projectId = project;\n  }\n\n  if (ssr?.cookies) {\n    const cookieHeader = mapCookieHeader(findLoginCookies(ssr.cookies));\n    if (cookieHeader) {\n      config.defaultHeaders = Object.assign(config.defaultHeaders || {}, {\n        Cookie: cookieHeader,\n      });\n    }\n  }\n\n  return config;\n};\n\n// export * from 'contensis-delivery-api';\n\ndeclare let window: Window &\n  typeof globalThis & {\n    versionStatus?: VersionStatus;\n  };\n\nexport class DeliveryApi {\n  cookies?: CookieObject;\n  ssr?: SSRContext;\n\n  constructor(ssr?: SSRContext) {\n    this.ssr = ssr;\n    this.cookies = ssr?.cookies.raw;\n  }\n\n  getClientSideVersionStatus = () => {\n    if (typeof window !== 'undefined') {\n      // Allow overriding versionStatus with the querystring\n      const { versionStatus } = parse(window.location.search);\n      if (versionStatus) return versionStatus;\n      // Client-side we will have a global variable set if rendered by SSR in production\n      if (typeof window.versionStatus !== 'undefined')\n        return window.versionStatus;\n      // For localhost development we can only work out versionStatus from the current hostname\n      const currentHostname = window.location.hostname;\n      return this.getVersionStatusFromHostname(currentHostname);\n    }\n    return null;\n  };\n\n  getServerSideVersionStatus = (request: Request) =>\n    request.query.versionStatus ||\n    deliveryApi.getVersionStatusFromHeaders(request.headers) ||\n    deliveryApi.getVersionStatusFromHostname(request.hostname);\n\n  getVersionStatusFromHeaders = (headers: IncomingHttpHeaders) => {\n    const versionStatusHeader = headers['x-entry-versionstatus'];\n    if (typeof versionStatusHeader !== 'undefined') return versionStatusHeader;\n    return null;\n  };\n\n  getVersionStatusFromHostname = (currentHostname: string) => {\n    if (currentHostname.indexOf('localhost') > -1) return 'latest';\n\n    if (currentHostname.endsWith('contensis.cloud')) {\n      if (currentHostname.indexOf('preview.') > -1) {\n        return 'latest';\n      } else {\n        return 'published';\n      }\n    }\n\n    if (currentHostname.endsWith('cloud.contensis.com')) {\n      if (currentHostname.indexOf('preview-') > -1) {\n        return 'latest';\n      } else {\n        return 'published';\n      }\n    }\n\n    return 'published';\n  };\n\n  search = (query: Query, linkDepth = 0, project?: string) => {\n    const client = Client.create(getClientConfig(project, this.ssr));\n    return client.entries.search(\n      query,\n      typeof linkDepth !== 'undefined' ? linkDepth : 1\n    );\n  };\n\n  getClient = (versionStatus: VersionStatus = 'published', project?: string) =>\n    Client.create({\n      ...getClientConfig(project, this.ssr),\n      versionStatus,\n    });\n\n  getEntry = (\n    id: string,\n    linkDepth = 0,\n    versionStatus: VersionStatus = 'published',\n    project?: string\n  ) => {\n    const client = Client.create({\n      ...getClientConfig(project, this.ssr),\n      versionStatus,\n    });\n    return client.entries.get({ id, linkDepth });\n  };\n}\n\nexport const deliveryApi = new DeliveryApi();\n\nexport const deliveryApiWithCookies = (ssr?: SSRContext) =>\n  new DeliveryApi(ssr);\n\nexport * from './CachedDeliveryApi';\n","import { Request, Response } from 'express';\nimport React, {\n  PropsWithChildren,\n  createContext,\n  useContext,\n  useState,\n} from 'react';\nimport { useCookies } from 'react-cookie';\nimport { useDispatch } from 'react-redux';\nimport { SSRContext as SSRContextType } from '~/models';\nimport { cachedSearchWithCookies } from '~/util/CachedDeliveryApi';\nimport { CookieHelper } from '~/user/util/CookieHelper.class';\n\nconst SSRContext = createContext<SSRContextType | null>(null);\n\n/** SSRContextProvider allows us to hold and access request-scoped references\n *  throughout the component tree\n *\n *  adding this in client side allows consumers to write universal code and use\n *  the same helpers and refs as in SSR */\nexport const SSRContextProvider = ({\n  children,\n  request,\n  response,\n}: PropsWithChildren<{ request?: Request; response?: Response }>) => {\n  // In SSR pass references to things in backing sagas\n  // we cannot access in a global scope\n  const dispatch = useDispatch();\n  const cookies = new CookieHelper(...useCookies());\n  const api = cachedSearchWithCookies({ cookies, dispatch, request, response });\n\n  const [context] = useState<SSRContextType>({\n    api,\n    cookies,\n    dispatch,\n    request,\n    response,\n  });\n\n  return (\n    <SSRContext.Provider value={{ ...context }}>{children}</SSRContext.Provider>\n  );\n};\n\nexport const useSSRContext = () => useContext(SSRContext) as SSRContextType;\n\nexport const useDeliveryApi = () => {\n  const { api } = useSSRContext();\n  return api;\n};\n"],"names":["CacheNode","constructor","key","value","next","prev","LruCache","limit","map","head","tail","size","get","node","remove","setHead","set","CachedSearch","ssr","_this$ssr","cache","cookies","raw","getClient","args","DeliveryApi","search","query","linkDepth","project","client","Client","create","getClientConfig","request","JSON","stringify","entries","searchUsingPost","id","versionStatus","fields","getContentType","contentTypes","getRootNode","options","nodes","getRoot","getNode","path","getAncestors","getChildren","getSiblings","execute","window","promise","catch","cachedSearch","cachedSearchWithCookies","mapCookieHeader","Object","name","join","getSsrReferer","url","URL","protocol","headers","host","href","ex","console","error","storeSurrogateKeys","response","keys","status","info","put","dispatch","reduxStore","setSurrogateKeys","deliveryApiConfig","config","DELIVERY_API_CONFIG","defaultHeaders","referer","responseHandler","PROXY_DELIVERY_API","rootUrl","projectId","cookieHeader","findLoginCookies","assign","Cookie","getClientSideVersionStatus","parse","location","currentHostname","hostname","getVersionStatusFromHostname","getServerSideVersionStatus","deliveryApi","getVersionStatusFromHeaders","versionStatusHeader","indexOf","endsWith","getEntry","deliveryApiWithCookies","SSRContext","createContext","SSRContextProvider","children","useDispatch","CookieHelper","useCookies","api","context","useState","React","createElement","Provider","useSSRContext","useContext","useDeliveryApi"],"mappings":"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"}